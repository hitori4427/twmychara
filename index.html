<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥•å¯†çš„å¶åƒå…¬ä¸»é¸è§’æ¨¡æ“¬å™¨</title>
    
    <!-- 1. å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. å¼•å…¥ Babel (è®“ç€è¦½å™¨çœ‹æ‡‚ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. å¼•å…¥ Tailwind CSS (ç¾åŒ–æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è§£æ±º Google Fonts æˆ–å…¶ä»–å­—é«”å•é¡Œ -->
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è‡ªå®šç¾©å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <!-- React ç¨‹å¼çš„æ›è¼‰é» -->
    <div id="root"></div>

    <!-- æ‚¨çš„ React ç¨‹å¼ç¢¼æ”¾åœ¨é€™è£¡ -->
    <script type="text/babel">
        // --- é€™è£¡å°‡åŸæœ¬çš„ import è½‰ç‚ºç€è¦½å™¨å¯ç”¨çš„è®Šæ•¸ ---
        const { useState, useRef, useEffect } = React;

        // --- ä»¥ä¸‹æ˜¯æ‚¨åŸæœ¬çš„ç¨‹å¼ç¢¼å…§å®¹ ---

        // é è¨­ä½”ä½åœ–
        const PLACEHOLDER_BG = "data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E";
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25' viewBox='0 0 800 600'%3E%3Crect fill='%23fce7f3' width='800' height='600'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='24' fill='%23db2777'%3Eç„¡èƒŒæ™¯åœ–%3C/text%3E%3C/svg%3E";

        // é è¨­ç´ æé€£çµ
        const DEFAULT_ASSETS = {
            startScreen: 'https://hitori4427.github.io/TW-aipri/%E5%B0%81%E9%9D%A2.jpeg',
            basicInfo: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112608801527996436/image.png',
            faceVoice: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112608830389014568/image.png',
            hair: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112608903952900136/image.png',
            skinEyes: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112608948169269288/image.png',
            color: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112609043635830914/image.png',
            makeup: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112608996756082748/image.png',
            final: 'https://cdn.discordapp.com/attachments/1058936921575465011/1112609104788770857/image.png',
        };

        // --- è¨­å®šæª” ---
        const stepConfig = {
            face: {
                sheet: 'faceVoice',
                label: 'è‡‰å‹',
                sprite: { rows: 2, cols: 4, yStart: 0.22, yEnd: 0.50 },
                options: [
                    { label: 'å°‘å¥³', url: 'https://hitori4427.github.io/TW-aipri/%E5%B0%91%E5%A5%B3.jpg' },
                    { label: 'æ´»åŠ›', url: 'https://hitori4427.github.io/TW-aipri/%E6%B4%BB%E5%8A%9B.jpg' },
                    { label: 'æŸ”å’Œ', url: 'https://hitori4427.github.io/TW-aipri/%E6%9F%94%E5%92%8C.jpg' },
                    { label: 'èªçœŸ', url: 'https://hitori4427.github.io/TW-aipri/%E8%AA%8D%E7%9C%9F.jpg' },
                    { label: 'å¼·å‹¢', url: 'https://hitori4427.github.io/TW-aipri/%E5%BC%B7%E5%8B%A2.jpg' },
                    { label: 'ç¾è‰·', url: 'https://hitori4427.github.io/TW-aipri/%E7%BE%8E%E8%89%B7.jpg' },
                    { label: 'æµªæ¼«', url: 'https://hitori4427.github.io/TW-aipri/%E6%B5%AA%E6%BC%AB.jpg' },
                    { label: 'ç¥ç§˜', url: 'https://hitori4427.github.io/TW-aipri/%E7%A5%9E%E7%A7%98.jpg' },
                ]
            },
            voice: {
                sheet: 'faceVoice',
                label: 'èªéŸ³',
                sprite: { rows: 2, cols: 3, yStart: 0.62, yEnd: 0.90 },
                options: [
                    { label: 'æ´»æ½‘', url: 'https://hitori4427.github.io/TW-aipri/%E6%B4%BB%E6%BD%91.jpg' },
                    { label: 'æº«æŸ”', url: 'https://hitori4427.github.io/TW-aipri/%E6%BA%AB%E6%9F%94.jpg' },
                    { label: 'ç›´ç‡', url: 'https://hitori4427.github.io/TW-aipri/%E7%9B%B4%E7%8E%87.jpg' },
                    { label: 'é…·ç‚«', url: 'https://hitori4427.github.io/TW-aipri/%E9%85%B7%E7%82%AB.jpg' },
                    { label: 'å„ªé›…', url: 'https://hitori4427.github.io/TW-aipri/%E5%84%AA%E9%9B%85.jpg' },
                    { label: 'å¯æ„›', url: 'https://hitori4427.github.io/TW-aipri/%E5%8F%AF%E6%84%9B.jpg' },
                ]
            },
            skin: {
                sheet: 'skinEyes',
                label: 'è†šè‰²',
                sprite: { rows: 2, cols: 3, yStart: 0.20, yEnd: 0.48 },
                options: [
                    { label: 'è†šè‰²A', url: 'https://hitori4427.github.io/TW-aipri/A.jpg' },
                    { label: 'è†šè‰²B', url: 'https://hitori4427.github.io/TW-aipri/B.jpg' },
                    { label: 'è†šè‰²C', url: 'https://hitori4427.github.io/TW-aipri/C.jpg' },
                    { label: 'è†šè‰²D', url: 'https://hitori4427.github.io/TW-aipri/D.jpg' },
                    { label: 'è†šè‰²E', url: 'https://hitori4427.github.io/TW-aipri/E.jpg' },
                    { label: 'è†šè‰²F', url: 'https://hitori4427.github.io/TW-aipri/F.jpg' },
                ]
            },
            eyes: {
                sheet: 'skinEyes',
                label: 'çœ¼ç›é¡è‰²',
                sprite: { rows: 1, cols: 4, yStart: 0.65, yEnd: 0.85 },
                options: [
                    { label: 'å¯§éœæœ¨è³ª', url: 'https://hitori4427.github.io/TW-aipri/%E5%AF%A7%E9%9D%9C%E6%9C%A8%E8%B3%AA.jpg' },
                    { label: 'ç´”æ·¨æµ·æ´‹', url: 'https://hitori4427.github.io/TW-aipri/%E7%B4%94%E6%B7%A8%E6%B5%B7%E6%B4%8B.jpg' },
                    { label: 'ç”œç¾æ«»æ¡ƒ', url: 'https://hitori4427.github.io/TW-aipri/%E7%94%9C%E7%BE%8E%E6%AB%BB%E6%A1%83.jpg' },
                    { label: 'é–ƒè€€è–„è·', url: 'https://hitori4427.github.io/TW-aipri/%E9%96%83%E8%80%80%E8%96%84%E8%8D%B7.jpg' },
                ]
            },
            bangs: {
                sheet: 'hair',
                label: 'ç€æµ·',
                sprite: { rows: 1, cols: 3, yStart: 0.20, yEnd: 0.40 },
                options: [
                    { label: 'æ´‹å¨ƒå¨ƒç€æµ·', url: 'https://hitori4427.github.io/TW-aipri/%E6%B4%8B%E5%A8%83%E5%A8%83%E7%80%8F%E6%B5%B7.jpg' },
                    { label: 'æ¸…çˆ½æ–œç€æµ·', url: 'https://hitori4427.github.io/TW-aipri/%E6%B8%85%E7%88%BD%E6%96%9C%E7%80%8F%E6%B5%B7.jpg' },
                    { label: 'å¸¥æ°£é€ å‹', url: 'https://hitori4427.github.io/TW-aipri/%E5%B8%A5%E6%B0%A3%E9%80%A0%E5%9E%8B.jpg' },
                ]
            },
            backHair: {
                sheet: 'hair',
                label: 'å¾Œæ–¹é«®å‹',
                customPositions: [
                    { l: 6, t: 55, w: 28, h: 18, label: 'ä¿çš®å¯æ„›é›™é¦¬å°¾', url: 'https://hitori4427.github.io/TW-aipri/%E4%BF%8F%E7%9A%AE%E5%8F%AF%E6%84%9B%E9%9B%99%E9%A6%AC%E5%B0%BE.jpg' },
                    { l: 36, t: 55, w: 28, h: 18, label: 'ä¿è½çŸ­é«®', url: 'https://hitori4427.github.io/TW-aipri/%E4%BF%90%E8%90%BD%E7%9F%AD%E9%AB%AE.jpg' },
                    { l: 66, t: 55, w: 28, h: 18, label: 'è‡ªç„¶é®‘ä¼¯é ­', url: 'https://hitori4427.github.io/TW-aipri/%E8%87%AA%E7%84%B6%E9%AE%91%E4%BC%AF%E9%A0%AD.jpg' },
                    { l: 20, t: 75, w: 28, h: 18, label: 'ä»¤äººæ†§æ†¬çš„é•·é«®', url: 'https://hitori4427.github.io/TW-aipri/%E4%BB%A4%E4%BA%BA%E6%86%A7%E6%86%AC%E7%9A%84%E9%95%B7%E9%AB%AE.jpg' },
                    { l: 52, t: 75, w: 28, h: 18, label: 'ç´”æ½”å´é¦¬å°¾', url: 'https://hitori4427.github.io/TW-aipri/%E7%B4%94%E6%BD%94%E5%81%B4%E9%A6%AC%E5%B0%BE.jpg' },
                ],
                sprite: { rows: 2, cols: 3, yStart: 0.55, yEnd: 0.95 }
            },
            hairColor: {
                sheet: 'color',
                label: 'é ­é«®é¡è‰²',
                sprite: { rows: 2, cols: 3, yStart: 0.20, yEnd: 0.55 },
                options: [
                    { label: 'äº®éº—é»‘', url: 'https://hitori4427.github.io/TW-aipri/%E4%BA%AE%E9%BA%97%E9%BB%91.jpg' },
                    { label: 'é»ƒé¶¯äºéº»ç°', url: 'https://hitori4427.github.io/TW-aipri/%E4%BA%9E%E9%BA%BB%E7%81%B0.jpg' },
                    { label: 'æ—¥å…‰é»ƒ', url: 'https://hitori4427.github.io/TW-aipri/%E6%97%A5%E5%85%89%E9%BB%83.jpg' },
                    { label: 'å¹¸é‹å¤©è—', url: 'https://hitori4427.github.io/TW-aipri/%E5%A4%A9%E8%97%8D.jpg' },
                    { label: 'è—è“ç´«', url: 'https://hitori4427.github.io/TW-aipri/%E8%97%8D%E8%8E%93%E7%B4%AB.jpg' },
                    { label: 'å¥‡å¹»ç²‰ç´…', url: 'https://hitori4427.github.io/TW-aipri/%E7%B2%89%E7%B4%85.jpg' },
                ]
            },
            highlights: {
                sheet: 'color',
                label: 'æŒ‘æŸ“',
                sprite: { rows: 1, cols: 1, yStart: 0.70, yEnd: 0.95 },
                options: [
                    { label: 'ç´°æŒ‘æŸ“', url: 'https://hitori4427.github.io/TW-aipri/%E7%B4%B0%E6%8C%91%E6%9F%93.jpg' },
                ]
            },
            highlightColor: {
                sheet: 'color',
                label: 'æŒ‘æŸ“é¡è‰²',
                sprite: { rows: 2, cols: 3, yStart: 0.20, yEnd: 0.55 },
                options: [
                    { label: 'äº®éº—é»‘', url: 'https://hitori4427.github.io/TW-aipri/%E4%BA%AE%E9%BA%97%E9%BB%91.jpg' },
                    { label: 'é»ƒé¶¯äºéº»ç°', url: 'https://hitori4427.github.io/TW-aipri/%E4%BA%9E%E9%BA%BB%E7%81%B0.jpg' },
                    { label: 'æ—¥å…‰é»ƒ', url: 'https://hitori4427.github.io/TW-aipri/%E6%97%A5%E5%85%89%E9%BB%83.jpg' },
                    { label: 'å¹¸é‹å¤©è—', url: 'https://hitori4427.github.io/TW-aipri/%E5%A4%A9%E8%97%8D.jpg' },
                    { label: 'è—è“ç´«', url: 'https://hitori4427.github.io/TW-aipri/%E8%97%8D%E8%8E%93%E7%B4%AB.jpg' },
                    { label: 'å¥‡å¹»ç²‰ç´…', url: 'https://hitori4427.github.io/TW-aipri/%E7%B2%89%E7%B4%85.jpg' },
                ]
            },
            makeup: {
                sheet: 'makeup',
                label: 'å…¶ä»–åŒ–å¦',
                sprite: { rows: 1, cols: 3, yStart: 0.20, yEnd: 0.45 },
                options: [
                    { label: 'çç é«®é£¾', url: 'https://hitori4427.github.io/TW-aipri/%E7%8F%8D%E7%8F%A0%E9%AB%AE%E9%A3%BE.jpg' },
                    { label: 'æ—©ç†Ÿå¥³å­©', url: 'https://hitori4427.github.io/TW-aipri/%E6%97%A9%E7%86%9F%E5%A5%B3%E5%AD%A9.jpg' },
                    { label: 'æ©¢åœ“å½¢çœ¼é¡', url: 'https://hitori4427.github.io/TW-aipri/%E6%A9%A2%E5%9C%93%E5%BD%A2%E7%9C%BC%E9%8F%A1.jpg' },
                ]
            },
            bracelet: {
                sheet: 'makeup',
                label: 'å¶åƒå…¬ä¸»æ‰‹ç’°',
                sprite: { rows: 1, cols: 3, yStart: 0.60, yEnd: 0.85 },
                options: [
                    { label: 'é™½è‘µæ¬¾å¼', url: 'https://hitori4427.github.io/TW-aipri/%E9%99%BD%E8%91%B5%E6%AC%BE%E5%BC%8F.jpg' },
                    { label: 'ç¾æœˆæ¬¾å¼', url: 'https://hitori4427.github.io/TW-aipri/%E7%BE%8E%E6%9C%88%E6%AC%BE%E5%BC%8F.jpg' },
                    { label: 'æ«»æ¬¾å¼', url: 'https://hitori4427.github.io/TW-aipri/%E6%AB%BB%E6%AC%BE%E5%BC%8F.jpg' },
                ]
            }
        };

        // --- å…ƒä»¶ ---

        const ResultThumbnail = ({ configKey, value, assets, customThumbnails }) => {
            const config = stepConfig[configKey];
            const imgSrc = assets[config.sheet];
            const customImg = customThumbnails[configKey];

            if (customImg) return <img src={customImg} className="w-full h-full object-cover" alt="custom" />;

            let optionData = null;
            let index = -1;

            if (config.options) {
                index = config.options.findIndex(o => o.label === value);
                optionData = config.options[index];
            } else if (config.customPositions) {
                index = config.customPositions.findIndex(p => p.label === value);
                optionData = config.customPositions[index];
            }

            if (optionData && optionData.url && optionData.url.trim() !== '') {
                return <img src={optionData.url} className="w-full h-full object-cover" alt={value} />;
            }

            if (!imgSrc || index === -1) {
                return <div className="w-full h-full bg-gray-100 flex items-center justify-center text-xs text-gray-300">?</div>;
            }

            const { rows, cols, yStart, yEnd } = config.sprite;
            const row = Math.floor(index / cols);
            const col = index % cols;

            return (
                <div className="w-full h-full relative overflow-hidden bg-white">
                    <img 
                        src={imgSrc} 
                        alt="thumb"
                        className="absolute max-w-none"
                        style={{
                            width: `${cols * 100}%`,
                            left: `-${col * 100}%`,
                            top: `-${(yStart * 100) + (row * ((yEnd*100 - yStart*100)/rows))}%`,
                            height: 'auto', 
                        }} 
                        onError={(e) => e.target.style.display='none'}
                    />
                </div>
            );
        };

        const Step4Item = ({ configKey, config, value, isLocked, assets, customThumbnails, handleCustomThumbnailUrl, handleCustomThumbnailUpload }) => {
            const [showUrlInput, setShowUrlInput] = useState(false);

            return (
                <div className={`relative flex items-center gap-2 p-2 rounded-xl border-2 ${isLocked ? 'bg-pink-50 border-pink-100' : 'bg-white border-gray-100'} ${configKey==='bracelet'?'col-span-full':''}`}>
                    <div className="w-14 h-14 flex-shrink-0 rounded-lg bg-white border border-gray-200 overflow-hidden shadow-sm relative group flex items-center justify-center">
                        {Array.isArray(value) ? (
                            value.length > 0 ? <ResultThumbnail configKey={configKey} value={value[0]} assets={assets} customThumbnails={customThumbnails} /> : <span className="text-xs text-gray-300">-</span>
                        ) : (
                            <ResultThumbnail configKey={configKey} value={value} assets={assets} customThumbnails={customThumbnails} />
                        )}
                        
                        <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <label className="text-white text-[9px] cursor-pointer hover:text-pink-300 mb-1">
                                ä¸Šå‚³
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleCustomThumbnailUpload(configKey, e.target.files[0])} />
                            </label>
                            <button className="text-white text-[9px] cursor-pointer hover:text-pink-300" onClick={() => setShowUrlInput(!showUrlInput)}>ç¶²å€</button>
                        </div>
                    </div>

                    <div className="flex-grow min-w-0">
                        {showUrlInput ? (
                            <div className="flex gap-1">
                                <input 
                                    type="text" 
                                    placeholder="è²¼ä¸Šç¶²å€..." 
                                    className="w-full text-xs border p-1 rounded"
                                    onBlur={(e) => { handleCustomThumbnailUrl(configKey, e.target.value); setShowUrlInput(false); }}
                                    onKeyDown={(e) => { if(e.key === 'Enter') { handleCustomThumbnailUrl(configKey, e.currentTarget.value); setShowUrlInput(false); }}}
                                    autoFocus
                                />
                                <button onClick={() => setShowUrlInput(false)} className="text-gray-400 text-xs">x</button>
                            </div>
                        ) : (
                            <>
                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">
                                    {config.label} {isLocked && 'ğŸ”’'}
                                </span>
                                <span className={`font-bold text-sm block truncate ${Array.isArray(value) && value.length > 0 ? 'text-gray-800' : (!Array.isArray(value) && value ? 'text-gray-800' : 'text-gray-400')}`}>
                                    {Array.isArray(value) 
                                        ? (value.length > 0 ? value.join(' + ') : 'æœªé¸æ“‡') 
                                        : (value || 'æœªé¸æ“‡')
                                    }
                                </span>
                                {Array.isArray(value) && value.length > 1 && (
                                    <div className="flex gap-1 mt-1 overflow-x-auto">
                                        {value.slice(1).map((v, i) => (
                                            <div key={i} className="w-6 h-6 rounded border overflow-hidden flex-shrink-0">
                                                <ResultThumbnail configKey={configKey} value={v} assets={assets} customThumbnails={customThumbnails} />
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // 3. App Component
        function App() {
            const [mainStep, setMainStep] = useState(0);
            const [currentStepKey, setCurrentStepKey] = useState('face');
            const [assets, setAssets] = useState(DEFAULT_ASSETS);
            const [customThumbnails, setCustomThumbnails] = useState({});
            const [basicInfo, setBasicInfo] = useState({
                nickname: '',
                birthMonth: '', 
                birthDay: '',
                age: '',
                qrCodeUrl: null,
            });
            
            const [selections, setSelections] = useState({
                face: null, voice: null, skin: null, eyes: null, bangs: null, 
                backHair: null, hairColor: null, highlights: null, highlightColor: null, makeup: [], bracelet: null
            });
            const fileInputRef = useRef(null);

            useEffect(() => {
                window.scrollTo(0, 0);
            }, [mainStep, currentStepKey]);

            const handleAssetUpload = (key, file) => {
                if (file) {
                    const url = URL.createObjectURL(file);
                    setAssets(prev => ({ ...prev, [key]: url }));
                }
            };

            const handleCustomThumbnailUpload = (key, file) => {
                if (file) {
                    const url = URL.createObjectURL(file);
                    setCustomThumbnails(prev => ({ ...prev, [key]: url }));
                }
            };

            const handleCustomThumbnailUrl = (key, url) => {
                if(url) setCustomThumbnails(prev => ({ ...prev, [key]: url }));
            }

            const handleBasicInfoChange = (e) => {
                setBasicInfo({ ...basicInfo, [e.target.name]: e.target.value });
            };

            const handleQrUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    setBasicInfo({ ...basicInfo, qrCodeUrl: url });
                }
            };

            const handleReset = () => {
                setSelections({
                    face: null, voice: null, skin: null, eyes: null, bangs: null, 
                    backHair: null, hairColor: null, highlights: null, highlightColor: null, makeup: [], bracelet: null
                });
                setBasicInfo({ nickname: '', birthMonth: '', birthDay: '', age: '', qrCodeUrl: null });
                setCustomThumbnails({});
                setMainStep(0); 
                setCurrentStepKey('face');
            };

            const handleBack = () => {
                if (mainStep === 1) {
                    setMainStep(0);
                } else if (mainStep === 2) {
                    if (currentStepKey === 'skin') setCurrentStepKey('voice');
                    else if (currentStepKey === 'voice') setCurrentStepKey('face');
                    else if (currentStepKey === 'face') setMainStep(1);
                } else if (mainStep === 3) {
                    setMainStep(2);
                    setCurrentStepKey('skin');
                } else if (mainStep === 4) {
                    setMainStep(3);
                    setCurrentStepKey('eyes'); 
                }
            };

            // æ–°å¢ï¼šæ‰‹å‹•è™•ç†ä¸‹ä¸€æ­¥
            const handleNextStep = () => {
                // å¦‚æœç›®å‰æ˜¯ Step 2ï¼Œæ ¹æ“šç•¶å‰ key æ±ºå®šå»å‘
                if (mainStep === 2) {
                    if (currentStepKey === 'face') setCurrentStepKey('voice');
                    else if (currentStepKey === 'voice') setCurrentStepKey('skin');
                    else if (currentStepKey === 'skin') {
                        setMainStep(3);
                        setCurrentStepKey('eyes');
                    }
                }
            };

            const handleSelection = (key, value) => {
                if (key === 'makeup') {
                    setSelections(prev => {
                        const current = Array.isArray(prev[key]) ? prev[key] : [];
                        if (current.includes(value)) {
                            return { ...prev, [key]: current.filter(v => v !== value) };
                        } else {
                            return { ...prev, [key]: [...current, value] };
                        }
                    });
                } else {
                    // æª¢æŸ¥ç•¶å‰æ˜¯å¦å·²ç¶“é¸ä¸­è©²é …ç›®
                    const isDeselecting = selections[key] === value;

                    setSelections(prev => ({ 
                        ...prev, 
                        // å¦‚æœæ˜¯é‡è¤‡é»æ“Šï¼Œè¨­ç‚º null (å–æ¶ˆ)ï¼Œå¦å‰‡è¨­ç‚ºæ–°å€¼
                        [key]: isDeselecting ? null : value 
                    }));
                    
                    // --- ç§»é™¤è‡ªå‹•è·³è½‰é‚è¼¯ ---
                    // ä½¿ç”¨è€…éœ€è¦æ‰‹å‹•æŒ‰ã€Œä¸‹ä¸€æ­¥ã€
                }
            };

            const ImageSelector = ({ configKey, onUpload }) => {
                const config = stepConfig[configKey];
                const bgImage = assets[config.sheet];
                const selectedValue = selections[configKey];
                
                const isSelected = (val) => {
                    if (configKey === 'makeup') {
                        return Array.isArray(selections[configKey]) && selections[configKey].includes(val);
                    }
                    return selections[configKey] === val;
                };
                
                const [imgError, setImgError] = useState(false);

                useEffect(() => {
                    setImgError(false); 
                }, [configKey]);

                useEffect(() => {
                    if(bgImage) setImgError(false);
                }, [bgImage]);

                // å–å¾—ç•¶å‰é¸ä¸­é …ç›®çš„åœ–ç‰‡ URL (ç”¨æ–¼å¤§é è¦½åœ–)
                const getSelectedImageUrl = () => {
                    if (!selectedValue) return null;
                    // å¦‚æœæ˜¯å¤šé¸ (makeup)ï¼Œåªé¡¯ç¤ºæœ€å¾Œé¸çš„é‚£å€‹ï¼Œæˆ–è€…ä¸é¡¯ç¤ºé è¦½
                    if (Array.isArray(selectedValue)) return null; 

                    const options = config.options || config.customPositions || [];
                    const selectedOption = options.find(o => o.label === selectedValue);
                    return selectedOption ? selectedOption.url : null;
                };

                const selectedImageUrl = getSelectedImageUrl();

                // ç‚ºäº†æ–¹ä¾¿ Step 2ï¼Œå¦‚æœ config æœ‰ options ä¸”æœ‰ urlï¼Œå°±ä½¿ç”¨ Grid æ¨¡å¼
                // é€™æ¬¡æˆ‘å€‘å¼·åˆ¶åªè¦æœ‰ options ä¸”æœ‰ url å°±ç”¨ gridï¼Œä¸¦åŠ ä¸Šå¤§é è¦½åœ–
                const useGridMode = imgError || !bgImage || (config.options && config.options.some(o => o.url));

                if (useGridMode) {
                    const gridCols = config.sprite ? config.sprite.cols : 3;
                    const items = config.options || config.customPositions || [];

                    return (
                        <div className="w-full max-w-3xl mx-auto p-2 flex flex-col h-full">
                            {/* --- æ–°å¢ï¼šå¤§å‹é è¦½å€ --- */}
                            <div className="flex-shrink-0 mb-4 bg-white/10 rounded-xl p-2 border-2 border-white/20 min-h-[200px] flex items-center justify-center relative overflow-hidden transition-all duration-300">
                                {selectedImageUrl ? (
                                    <img 
                                        src={selectedImageUrl} 
                                        alt="Preview" 
                                        className="max-h-[250px] w-auto object-contain animate-fadeIn drop-shadow-2xl" 
                                    />
                                ) : (
                                    <div className="text-center text-gray-400">
                                        <div className="text-4xl mb-2">ğŸ‘†</div>
                                        <p>è«‹é¸æ“‡{config.label}</p>
                                    </div>
                                )}
                            </div>
                            
                            {/* é¸é …è¨­å®šæŒ‰éˆ• (Optional) */}
                            <div className="flex justify-end mb-2">
                                <label className="text-xs text-gray-400 hover:text-pink-500 cursor-pointer flex items-center gap-1">
                                    <span>âš™ï¸ è¨­å®šåº•åœ–</span>
                                    <input 
                                        type="file" 
                                        accept="image/*" 
                                        className="hidden" 
                                        onChange={(e) => onUpload(config.sheet, e.target.files[0])} 
                                    />
                                </label>
                            </div>

                            {/* é¸é … Grid */}
                            <div className={`grid gap-4 pb-20`} style={{ gridTemplateColumns: `repeat(${Math.min(gridCols, 4)}, 1fr)` }}>
                                {items.map((item, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => handleSelection(configKey, item.label)}
                                        className={`
                                            relative aspect-square rounded-2xl border-4 overflow-hidden flex flex-col items-center justify-end
                                            transition-all duration-200 shadow-md hover:shadow-lg
                                            ${isSelected(item.label) ? 'border-pink-500 ring-2 ring-pink-300 scale-105 bg-pink-50' : 'border-white hover:border-pink-200 bg-white'}
                                        `}
                                    >
                                        <div className="absolute inset-0 p-2">
                                            {item.url ? (
                                                <img 
                                                    src={item.url} 
                                                    alt={item.label} 
                                                    className="w-full h-full object-contain drop-shadow-sm" 
                                                />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-4xl bg-gray-100 rounded-xl text-gray-300">
                                                    ?
                                                </div>
                                            )}
                                        </div>

                                        <div className="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm py-1 text-center">
                                            <span className={`text-xs font-bold ${isSelected(item.label) ? 'text-pink-600' : 'text-gray-600'}`}>
                                                {item.label}
                                            </span>
                                        </div>

                                        {isSelected(item.label) && (
                                            <div className="absolute top-2 right-2 bg-pink-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg z-10">
                                                âœ“
                                            </div>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                }

                // --- é€™æ˜¯åŸæœ¬çš„ã€Œåœ–ç‰‡å®šä½æ¨¡å¼ã€(å¦‚ backHair)ï¼Œç¶­æŒåŸæ¨£ ---
                return (
                    <div className="relative w-full max-w-2xl mx-auto shadow-xl rounded-xl overflow-hidden bg-gray-100 border-2 border-pink-200 group select-none min-h-[300px]">
                        <img 
                            src={bgImage} 
                            alt={config.label} 
                            className="w-full h-auto block pointer-events-none" 
                            onError={() => setImgError(true)}
                        />

                        <label className={`absolute top-2 right-2 z-20 bg-black/60 hover:bg-pink-500 text-white text-xs px-3 py-1.5 rounded-full cursor-pointer transition-all opacity-0 group-hover:opacity-100`}>
                            æ›´æ›åº•åœ–
                            <input 
                                type="file" 
                                accept="image/*" 
                                className="hidden" 
                                onChange={(e) => onUpload(config.sheet, e.target.files[0])} 
                            />
                        </label>

                        <div className="absolute inset-0 z-10">
                            {config.customPositions ? (
                                config.customPositions.map((pos, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => handleSelection(configKey, pos.label)}
                                        className={`absolute rounded-xl transition-all duration-200 overflow-hidden border-2
                                            ${isSelected(pos.label) ? 'border-pink-500 shadow-[0_0_15px_rgba(236,72,153,0.6)] scale-105' : 'border-transparent hover:bg-white/20'}
                                        `}
                                        style={{
                                            left: `${pos.l}%`,
                                            top: `${pos.t}%`,
                                            width: `${pos.w}%`,
                                            height: `${pos.h}%`,
                                        }}
                                    >
                                        {pos.url ? (
                                            <img src={pos.url} alt={pos.label} className="absolute inset-0 w-full h-full object-contain bg-white/50" />
                                        ) : (
                                            (imgError || !bgImage) && <span className="flex items-center justify-center h-full text-xs font-bold text-gray-500 bg-gray-200/80">{pos.label}</span>
                                        )}
                                        
                                        {isSelected(pos.label) && <div className="absolute top-1 right-1 bg-pink-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow z-10">âœ“</div>}
                                    </button>
                                ))
                            ) : (
                                // é€™æ®µ fallback åŸºæœ¬ä¸Šä¸å¤ªæœƒè·‘åˆ°äº†ï¼Œå› ç‚ºå¤§éƒ¨åˆ†éƒ½é€² Grid Mode äº†
                                (() => {
                                    const { rows, cols, yStart, yEnd } = config.sprite;
                                    const colWidth = 100 / cols;
                                    const areaHeight = yEnd - yStart;
                                    const rowHeight = areaHeight / rows;
                                    const gapY = 1; 
                                    const gapX = 1;

                                    const buttons = [];
                                    config.options.forEach((opt, idx) => {
                                        const r = Math.floor(idx / cols);
                                        const c = idx % cols;
                                        const top = (yStart + r * rowHeight) * 100;
                                        const left = c * colWidth;
                                        const height = rowHeight * 100;

                                        buttons.push(
                                            <button
                                                key={idx}
                                                onClick={() => handleSelection(configKey, opt.label)}
                                                className={`absolute rounded-xl transition-all duration-200 overflow-hidden border-2
                                                    ${isSelected(opt.label) ? 'border-pink-500 shadow-[0_0_15px_rgba(236,72,153,0.6)] scale-105' : 'border-transparent hover:bg-white/20'}
                                                `}
                                                style={{
                                                    top: `${top + gapY}%`,
                                                    left: `${left + gapX}%`,
                                                    height: `${height - gapY*2}%`,
                                                    width: `${colWidth - gapX*2}%`,
                                                }}
                                            >
                                                {opt.url ? (
                                                    <img src={opt.url} alt={opt.label} className="absolute inset-0 w-full h-full object-contain bg-white/50" />
                                                ) : (
                                                    (imgError || !bgImage) && <span className="flex items-center justify-center h-full text-xs font-bold text-gray-500 bg-gray-200/80">{opt.label}</span>
                                                )}

                                                {isSelected(opt.label) && <div className="absolute top-1 right-1 bg-pink-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow z-10">âœ“</div>}
                                            </button>
                                        );
                                    });
                                    return buttons;
                                })()
                            )}
                        </div>
                    </div>
                );
            };

            const renderStep0 = () => (
                <div 
                    className="min-h-screen w-full flex items-center justify-center cursor-pointer relative bg-pink-50" 
                    onClick={() => setMainStep(1)}
                >
                    <div className="absolute inset-0 flex items-center justify-center">
                        <img 
                            src={assets.startScreen || PLACEHOLDER_IMG}
                            alt="Start Screen"
                            className="max-w-full max-h-full w-auto h-auto object-contain shadow-lg" 
                        />
                    </div>

                    {!assets.startScreen && (
                        <div className="relative z-10 text-center p-10 bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl animate-pulse">
                            <h1 className="text-4xl font-black text-pink-600 mb-2">ç¥•å¯†çš„å¶åƒå…¬ä¸»<br/>é¸è§’æ¨¡æ“¬å™¨</h1>
                            <p className="text-gray-500 font-bold">é»æ“Šç•«é¢é–‹å§‹</p>
                            <p className="text-xs text-gray-400 mt-4">(è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š startScreen åœ–ç‰‡)</p>
                        </div>
                    )}
                    
                    {assets.startScreen && (
                        <div className="absolute bottom-10 left-0 right-0 text-center z-10">
                            <span className="inline-block bg-black/30 backdrop-blur-sm text-white px-6 py-2 rounded-full font-bold text-xl animate-bounce border border-white/50">
                                é»æ“Šç•«é¢é–‹å§‹ / Tap to Start
                            </span>
                        </div>
                    )}
                </div>
            );

            const renderStep1 = () => (
                <div className="relative min-h-screen flex flex-col items-center justify-center bg-gray-100">
                    <div className="absolute inset-0 overflow-hidden bg-gray-200">
                        <img 
                            src={assets.basicInfo} 
                            className="w-full h-full object-cover opacity-60 blur-sm" 
                            alt="bg" 
                            onError={(e) => e.target.style.display='none'} 
                        />
                    </div>
                    <div className="relative z-10 w-full max-w-lg p-4">
                        <div className="bg-white/95 backdrop-blur-md p-6 rounded-3xl shadow-2xl border-4 border-pink-200 space-y-5">
                           <div className="flex justify-between items-center border-b-2 border-pink-100 pb-2">
                             <h2 className="text-xl font-black text-pink-600 text-center">å¶åƒæª”æ¡ˆ</h2>
                             <label className="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600 cursor-pointer transition-colors">
                               æ›´æ›èƒŒæ™¯
                               <input 
                                 type="file" 
                                 accept="image/*" 
                                 className="hidden" 
                                 onChange={(e) => handleAssetUpload('basicInfo', e.target.files[0])} 
                               />
                             </label>
                           </div>
                           <div>
                              <label className="text-xs font-bold text-gray-500">æš±ç¨±</label>
                              <input type="text" name="nickname" value={basicInfo.nickname} onChange={handleBasicInfoChange} className="w-full p-2 text-lg font-bold border-b-2 border-pink-300 bg-transparent outline-none" placeholder="è¼¸å…¥æš±ç¨±..." />
                           </div>
                           <div className="flex gap-4">
                              <div className="flex-1">
                                 <label className="text-xs font-bold text-gray-500">ç”Ÿæ—¥</label>
                                 <div className="flex items-end gap-2 w-full p-2 border-b-2 border-pink-300">
                                    <input 
                                        type="number" 
                                        name="birthMonth"
                                        placeholder="MM" 
                                        min="1" max="12"
                                        value={basicInfo.birthMonth}
                                        className="w-12 bg-transparent outline-none text-center font-bold text-lg"
                                        onChange={handleBasicInfoChange}
                                    />
                                    <span className="text-gray-500 font-bold text-sm mb-1">æœˆ</span>
                                    <input 
                                        type="number" 
                                        name="birthDay"
                                        placeholder="DD" 
                                        min="1" max="31"
                                        value={basicInfo.birthDay}
                                        className="w-12 bg-transparent outline-none text-center font-bold text-lg"
                                        onChange={handleBasicInfoChange}
                                    />
                                    <span className="text-gray-500 font-bold text-sm mb-1">æ—¥</span>
                                 </div>
                              </div>
                              <div className="w-20">
                                 <label className="text-xs font-bold text-gray-500">å¹´é½¡</label>
                                 <input type="number" name="age" value={basicInfo.age} onChange={handleBasicInfoChange} className="w-full p-2 text-lg font-bold border-b-2 border-pink-300 bg-transparent outline-none" placeholder="16" />
                              </div>
                           </div>
                           <div>
                              <label className="text-xs font-bold text-gray-500 block mb-2">QR Code</label>
                              <div onClick={() => fileInputRef.current.click()} className="w-full h-32 border-2 border-dashed border-pink-400 rounded-xl flex items-center justify-center bg-pink-50 cursor-pointer hover:bg-pink-100 transition-colors">
                                {basicInfo.qrCodeUrl ? <img src={basicInfo.qrCodeUrl} className="h-full object-contain" /> : <span className="text-pink-400 font-bold">+ ä¸Šå‚³ç…§ç‰‡</span>}
                              </div>
                              <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleQrUpload} />
                           </div>
                           <div className="flex gap-2">
                                <button onClick={() => setMainStep(0)} className="w-1/4 py-3 rounded-full font-bold text-gray-500 bg-gray-200 hover:bg-gray-300 transition-colors">è¿”å›</button>
                                <button onClick={() => setMainStep(2)} disabled={!basicInfo.nickname} className={`w-3/4 py-3 rounded-full font-bold text-white shadow-lg ${basicInfo.nickname ? 'bg-pink-500' : 'bg-gray-300'}`}>ä¸‹ä¸€æ­¥</button>
                           </div>
                        </div>
                    </div>
                </div>
            );

            const renderStep2 = () => (
                <div className="min-h-screen bg-gray-900 flex flex-col">
                   <div className="bg-gray-800 text-white p-4 flex justify-between items-center shadow-lg z-20">
                      <span className="font-bold">æ­¥é©Ÿ 2: åŸºç¤è¨­å®š - {stepConfig[currentStepKey].label}</span>
                      <div className="flex gap-2">
                         <button onClick={handleBack} className="text-xs md:text-sm text-gray-400 border border-gray-600 px-3 py-1 rounded-full hover:bg-gray-700 transition-colors">ä¸Šä¸€æ­¥</button>
                         <button onClick={handleReset} className="text-xs md:text-sm text-red-400 border border-red-800/50 px-3 py-1 rounded-full hover:bg-red-900/20 transition-colors">å¾é ­é–‹å§‹</button>
                      </div>
                   </div>
                   
                   <div className="flex-grow overflow-y-auto">
                      <ImageSelector configKey={currentStepKey} onUpload={handleAssetUpload} />
                   </div>

                   {/* æ–°å¢ï¼šåº•éƒ¨ç¢ºèªæŒ‰éˆ•å€ */}
                   <div className="p-4 bg-gray-800 border-t border-gray-700 flex justify-center">
                        <button 
                            onClick={handleNextStep}
                            disabled={!selections[currentStepKey]} // å¦‚æœæ²’é¸ï¼Œç¦æ­¢ä¸‹ä¸€æ­¥ (å¯é¸)
                            className={`
                                w-full max-w-sm py-3 rounded-full font-black text-lg shadow-lg transition-all
                                ${selections[currentStepKey] 
                                    ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white hover:scale-105 hover:shadow-pink-500/50' 
                                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'}
                            `}
                        >
                            {selections[currentStepKey] ? 'ç¢ºèªï¼Œä¸‹ä¸€æ­¥ï¼ â†’' : 'è«‹é¸æ“‡ä¸€å€‹é¸é …'}
                        </button>
                   </div>
                </div>
            );

            const renderStep3 = () => {
                const tabs = [
                    { key: 'eyes', label: 'çœ¼ç›' },
                    { key: 'bangs', label: 'ç€æµ·' },
                    { key: 'backHair', label: 'å¾Œé«®' },
                    { key: 'hairColor', label: 'é«®è‰²' },
                    { key: 'highlights', label: 'æŒ‘æŸ“' },
                    { key: 'highlightColor', label: 'æŒ‘æŸ“é¡è‰²' },
                    { key: 'makeup', label: 'åŒ–å¦' },
                    { key: 'bracelet', label: 'æ‰‹ç’°' },
                ];
                return (
                    <div className="min-h-screen bg-gray-100 flex flex-col">
                         <div className="bg-white p-2 shadow-md sticky top-0 z-20">
                            <div className="flex justify-between items-center mb-2 px-1">
                                <div className="flex items-center gap-2">
                                    <button onClick={handleBack} className="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">â† ä¸Šä¸€æ­¥</button>
                                    <button onClick={handleReset} className="text-xs bg-red-100 text-red-500 px-2 py-1 rounded hover:bg-red-200">â†º é‡ä¾†</button>
                                    <span className="font-bold text-gray-700 ml-2">ç´°éƒ¨è¨­å®š</span>
                                </div>
                                <button onClick={() => setMainStep(4)} className="bg-green-500 text-white px-4 py-1.5 rounded-full font-bold shadow text-sm">å®Œæˆè¨­å®š âœ“</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                               {tabs.map(tab => (
                                 <button key={tab.key} onClick={() => setCurrentStepKey(tab.key)} className={`flex-shrink-0 px-4 py-1.5 rounded-full font-bold text-sm border ${currentStepKey === tab.key ? 'bg-pink-600 text-white border-pink-600' : 'bg-gray-100 text-gray-500 border-gray-200'}`}>
                                   {tab.label}{selections[tab.key] && (Array.isArray(selections[tab.key]) ? selections[tab.key].length > 0 : selections[tab.key]) && ' â€¢'}
                                 </button>
                               ))}
                            </div>
                         </div>
                         <div className="flex-grow p-2 flex items-center justify-center bg-gray-800 overflow-y-auto">
                            <ImageSelector configKey={currentStepKey} onUpload={handleAssetUpload} />
                         </div>
                    </div>
                );
            };

            const renderStep4 = () => (
                <div className="min-h-screen bg-gradient-to-br from-pink-300 to-purple-400 p-4 font-sans overflow-y-auto">
                    <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-white flex flex-col md:flex-row">
                         <div className="relative w-full md:w-5/12 min-h-[400px] bg-gray-100 overflow-hidden group flex items-center justify-center">
                             {assets.final ? 
                                <img src={assets.final} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} /> 
                                : <div className="w-full h-full flex items-center justify-center text-gray-400">ç„¡åº•åœ–</div>
                             }
                             <label className="absolute top-2 right-2 bg-black/50 hover:bg-pink-500 text-white text-xs px-2 py-1 rounded cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                                æ›´æ›åº•åœ–
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleAssetUpload('final', e.target.files[0])} />
                             </label>
                             <div className="absolute inset-0 flex flex-col justify-center items-center bg-white/20 backdrop-blur-[2px]">
                                <div className="w-48 h-48 bg-white rounded-2xl shadow-xl p-2 mb-6 rotate-2 border-4 border-pink-200">
                                   {basicInfo.qrCodeUrl ? <img src={basicInfo.qrCodeUrl} className="w-full h-full object-contain" /> : <div className="w-full h-full flex items-center justify-center text-sm text-gray-300 font-bold">NO QR</div>}
                                </div>
                                <div className="text-center">
                                   <h1 className="text-5xl font-black text-white drop-shadow-md tracking-wide mb-2" style={{ WebkitTextStroke: '1px #ec4899' }}>{basicInfo.nickname}</h1>
                                   <div className="inline-block bg-pink-600/90 text-white px-4 py-1 rounded-full text-base font-bold shadow-lg border border-pink-400">
                                     {basicInfo.age || '?'} æ­² <span className="mx-1">|</span> {basicInfo.birthMonth || '??'}æœˆ{basicInfo.birthDay || '??'}æ—¥
                                   </div>
                                </div>
                             </div>
                         </div>
                         <div className="w-full md:w-7/12 p-6 bg-white flex flex-col">
                            <div className="flex justify-between items-center mb-4 border-b-2 border-pink-100 pb-2">
                               <h3 className="text-2xl font-black text-gray-800">å‡ºé“è¨­å®šè¡¨</h3>
                            </div>
                            <p className="text-xs text-gray-400 mb-4 bg-gray-50 p-2 rounded">
                               ğŸ’¡ è‹¥ç¸®åœ–ä¸æº–ç¢ºï¼Œå¯é»æ“Šã€Œä¸Šå‚³ã€æ›´æ›æˆ–è²¼ä¸Šç¶²å€ã€‚
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm flex-grow content-start">
                               {Object.keys(stepConfig).map((key) => {
                                 const config = stepConfig[key];
                                 const value = selections[key];
                                 const isLocked = ['face','voice','skin'].includes(key);
                                 return (
                                   <Step4Item 
                                        key={key}
                                        configKey={key}
                                        config={config}
                                        value={value}
                                        isLocked={isLocked}
                                        assets={assets}
                                        customThumbnails={customThumbnails}
                                        handleCustomThumbnailUrl={handleCustomThumbnailUrl}
                                        handleCustomThumbnailUpload={handleCustomThumbnailUpload}
                                   />
                                 );
                               })}
                            </div>
                            {/* Step 4 Footer Buttons */}
                            <div className="mt-6 pt-4 border-t border-gray-100 text-center flex justify-center gap-4">
                               <button onClick={handleBack} className="text-gray-600 font-bold text-sm bg-gray-100 px-4 py-2 rounded-full hover:bg-gray-200 transition-colors">â† å›ä¸Šä¸€æ­¥ä¿®æ”¹</button>
                               <button onClick={handleReset} className="text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full hover:bg-red-100 transition-colors">â†º é‡æ–°è£½ä½œ</button>
                            </div>
                         </div>
                    </div>
                </div>
            );

            return (
                <>
                    {mainStep === 0 && renderStep0()}
                    {mainStep === 1 && renderStep1()}
                    {mainStep === 2 && renderStep2()}
                    {mainStep === 3 && renderStep3()}
                    {mainStep === 4 && renderStep4()}
                </>
            );
        }

        // 4. å•Ÿå‹• React App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>